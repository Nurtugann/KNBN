{% extends 'main/base.html' %}
{% block title %}–î–∞—à–±–æ—Ä–¥: –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º{% endblock %}

{% block extra_css %}
<style>
  .card {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .card-title {
    font-size: 1.1rem;
    font-weight: bold;
  }
  .region-table th, .region-table td {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</h1>

  <div class="row">
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-title">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π</div>
        <div class="display-6">{{ total_companies }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning">
        <div class="card-title">–°—É–º–º–∞—Ä–Ω—ã–π –¥–æ–ª–≥</div>
        <div class="display-6">{{ total_debt|floatformat:0 }} ‚Ç∏</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-title">–ü–æ–≥–∞—à–µ–Ω–æ</div>
        <div class="display-6">{{ total_repaid|floatformat:0 }} ‚Ç∏</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-title">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
        <div class="display-6">{{ overdue_count }}</div>
      </div>
    </div>
  </div>

  <h3 class="mt-4">üìç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</h3>
  <table class="table table-bordered region-table">
    <thead class="table-light">
      <tr>
        <th>–†–µ–≥–∏–æ–Ω</th>
        <th>–ö–æ–º–ø–∞–Ω–∏–π</th>
        <th>–û–±—â–∏–π –¥–æ–ª–≥</th>
        <th>–ü–æ–≥–∞—à–µ–Ω–æ</th>
        <th>–ü–æ–≥–∞—à–µ–Ω–æ %</th>
      </tr>
    </thead>
    <tbody>
      {% for region in region_stats %}
      <tr>
        <td>{{ region.region }}</td>
        <td>{{ region.count }}</td>
        <td>{{ region.debt|floatformat:0 }} ‚Ç∏</td>
        <td>{{ region.paid|floatformat:0 }} ‚Ç∏</td>
        <td>
          {% if region.debt > 0 %}
            {{ region.paid|divisibleby:region.debt|floatformat:2 }}%
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3 class="mt-4">‚öñÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
  <table class="table table-bordered region-table">
    <thead class="table-light">
      <tr>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–ö–æ–º–ø–∞–Ω–∏–π</th>
      </tr>
    </thead>
    <tbody>
      {% for s in status_stats %}
      <tr>
        <td>{{ s.status__name }}</td>
        <td>{{ s.count }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- JSON-–¥–∞–Ω–Ω—ã–µ -->
  {{ region_stats|json_script:"region-data" }}
  {{ status_stats|json_script:"status-data" }}

  <h3 class="mt-5">üìà –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</h3>
  <div id="regionBarChart" style="width:100%; max-width:800px; height:400px; margin:auto;"></div>

  <h3 class="mt-5">üìä –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
  <div id="statusBarChart" style="width:100%; max-width:800px; height:400px; margin:auto;"></div>

  <h4 class="mt-5">üìä –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º (–¥–æ–ª–≥–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∏)</h4>
  <div id="regionDebtChart" style="width:100%; max-width:900px; height:400px; margin:auto;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const regionData = JSON.parse(document.getElementById("region-data").textContent);
  const statusData = JSON.parse(document.getElementById("status-data").textContent);

  const regionLabels = regionData.map(r => r.region);
  const regionCounts = regionData.map(r => r.count);

  Plotly.newPlot("regionBarChart", [{
    x: regionLabels,
    y: regionCounts,
    type: 'bar',
    marker: { color: 'rgba(0, 123, 255, 0.7)' }
  }], {
    title: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º",
    xaxis: { title: "–†–µ–≥–∏–æ–Ω", automargin: true },
    yaxis: { title: "–ö–æ–º–ø–∞–Ω–∏–π" },
    margin: { b: 100 }
  });

  const sortedStatusData = statusData.slice().sort((a, b) => a["status__order"] - b["status__order"]);
  const statusLabels = sortedStatusData.map(s => s["status__name"]);
  const statusCounts = sortedStatusData.map(s => s["count"]);


  Plotly.newPlot("statusBarChart", [{
    x: statusLabels,
    y: statusCounts,
    type: 'bar',
    marker: { color: 'rgba(40, 167, 69, 0.7)' }
  }], {
    title: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º",
    xaxis: { title: "–°—Ç–∞—Ç—É—Å", automargin: true },
    yaxis: {
      title: "–ö–æ–º–ø–∞–Ω–∏–π",
      dtick: 1  // üëà –≤–æ—Ç —ç—Ç–æ –¥–æ–±–∞–≤—å
    },
    margin: { b: 100 }
  });


  const regionDebts = regionData.map(r => r.debt);
  const regionRemaining = regionData.map(r => r.debt - r.paid);

  Plotly.newPlot("regionDebtChart", [
    {
      x: regionLabels,
      y: regionDebts,
      name: "–î–æ–ª–≥",
      type: "bar"
    },
    {
      x: regionLabels,
      y: regionRemaining,
      name: "–û—Å—Ç–∞—Ç–æ–∫",
      type: "bar"
    }
  ], {
    barmode: "group",
    title: "–°—É–º–º–∞—Ä–Ω—ã–π –¥–æ–ª–≥ –∏ –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º",
    xaxis: { title: "–†–µ–≥–∏–æ–Ω", automargin: true },
    yaxis: { title: "–°—É–º–º–∞ (‚Ç∏)" },
    margin: { b: 100 }
  });
</script>
{% endblock %}
