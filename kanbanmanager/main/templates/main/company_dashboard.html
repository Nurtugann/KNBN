{% extends 'main/base.html' %}
{% block title %}–î–∞—à–±–æ—Ä–¥: –ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #kazakhstan-map { width: 100%; height: 500px; margin-bottom: 2rem; }
  .card {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .card-title {
    font-size: 1.1rem;
    font-weight: bold;
  }
  .region-table th, .region-table td {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">üìç –ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</h1>

  <!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
  <div id="kazakhstan-map" style="width:100%;height:400px;margin-bottom:2rem;"></div>

  <!-- –û–±—â–∏–µ –∏—Ç–æ–≥–∏ -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-title">–í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π</div>
        <div class="display-6" id="totalCompanies">{{ total_companies }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning">
        <div class="card-title">–°—É–º–º–∞—Ä–Ω—ã–π –¥–æ–ª–≥</div>
        <div class="display-6" id="totalDebt">{{ total_debt|floatformat:0 }} ‚Ç∏</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-title">–ü–æ–≥–∞—à–µ–Ω–æ</div>
        <div class="display-6" id="totalRepaid">{{ total_repaid|floatformat:0 }} ‚Ç∏</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-title">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
        <div class="display-6" id="overdueCount">{{ overdue_count }}</div>
      </div>
    </div>
  </div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º -->
  <h4 class="mt-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</h4>
  <div class="row g-3">
    {% for region in region_stats %}
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100">
          <div class="card-header text-center fw-bold">
            {{ region.region }}
          </div>
          <div class="card-body p-2">
            <ul class="list-unstyled mb-0">
              <li>üè¢ <strong>–ö–æ–º–ø–∞–Ω–∏–π:</strong> {{ region.count }}</li>
              <li>üí∞ <strong>–î–æ–ª–≥:</strong> {{ region.debt|floatformat:0 }} ‚Ç∏</li>
              <li>‚úÖ <strong>–ü–æ–≥–∞—à–µ–Ω–æ:</strong> {{ region.paid|floatformat:0 }} ‚Ç∏</li>
              <li>üìä <strong>–ü–æ–≥–∞—à–µ–Ω–æ %:</strong>
                {% if region.debt > 0 %}
                  {{ region.paid|divisibleby:region.debt|floatformat:2 }}%
                {% else %}
                  ‚Äî
                {% endif %}
              </li>
            </ul>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
  <div id="regionBarChart" style="height:400px;" class="mt-5"></div>
  <div id="statusBarChart" style="height:400px;" class="mt-5"></div>
</div>

<!-- JSON-–¥–∞–Ω–Ω—ã–µ –¥–ª—è JS -->
{{ region_stats|json_script:"region-data" }}
{{ status_stats|json_script:"status-data" }}
{% endblock %}


{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const regionData = JSON.parse(document.getElementById("region-data").textContent);
  const statusData = JSON.parse(document.getElementById("status-data").textContent);

  // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
  const map = L.map('kazakhstan-map').setView([48.0, 66.9], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // 2. –°—Ç–∏–ª—å –∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ —Ä–µ–≥–∏–æ–Ω–∞—Ö
  function style(feature) {
    return { fillColor: '#add8e6', weight: 1, color: '#555', fillOpacity: 0.7 };
  }

  function onEachFeature(feature, layer) {
    layer.on({
      click: () => updateRegionCharts(feature.properties.name),
      mouseover: () => layer.setStyle({ fillOpacity: 1 }),
      mouseout: () => layer.setStyle({ fillOpacity: 0.7 })
    });
  }

  fetch('/static/geo/gadm41_KAZ_1.json')
    .then(res => res.json())
    .then(data => L.geoJSON(data, { style, onEachFeature }).addTo(map));

  // 3. –ù–∞—á–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
  const regionLabels = regionData.map(r => r.region);
  const regionCounts = regionData.map(r => r.count);

  Plotly.newPlot("regionBarChart", [{
    x: regionLabels,
    y: regionCounts,
    type: 'bar',
    marker: { color: 'rgba(0, 123, 255, 0.7)' }
  }], {
    title: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º",
    xaxis: { title: "–†–µ–≥–∏–æ–Ω" },
    yaxis: { title: "–ö–æ–º–ø–∞–Ω–∏–π" }
  });

  const sortedStatus = statusData.slice().sort((a, b) => a.status__order - b.status__order);
  const statusLabels = sortedStatus.map(s => s.status__name);
  const statusCounts = sortedStatus.map(s => s.count);

  Plotly.newPlot("statusBarChart", [{
    x: statusLabels,
    y: statusCounts,
    type: 'bar',
    marker: { color: 'rgba(40, 167, 69, 0.7)' }
  }], {
    title: "–ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º",
    xaxis: { title: "–°—Ç–∞—Ç—É—Å", automargin: true },
    yaxis: { title: "–ö–æ–º–ø–∞–Ω–∏–π", dtick: 1 }
  });

  // 4. –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ä–µ–≥–∏–æ–Ω
  function updateRegionCharts(regionName) {
    const region = regionData.find(r => r.region === regionName);
    if (!region) return;

    document.getElementById("totalCompanies").innerText = region.count;
    document.getElementById("totalDebt").innerText = Math.round(region.debt).toLocaleString() + " ‚Ç∏";
    document.getElementById("totalRepaid").innerText = Math.round(region.paid).toLocaleString() + " ‚Ç∏";
    document.getElementById("overdueCount").innerText = ""; // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ª–æ–≥–∏–∫–æ–π —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å

    Plotly.react("regionBarChart", [{
      x: [regionName],
      y: [region.count],
      type: 'bar',
      marker: { color: 'rgba(0, 123, 255, 0.7)' }
    }], {
      title: `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π –≤ —Ä–µ–≥–∏–æ–Ω–µ: ${regionName}`,
      xaxis: { title: "–†–µ–≥–∏–æ–Ω" },
      yaxis: { title: "–ö–æ–º–ø–∞–Ω–∏–π", dtick: 1 }
    });

    const regionStatus = statusData.filter(s => s.region === regionName);
    const labels = regionStatus.map(s => s.status__name);
    const counts = regionStatus.map(s => s.count);

    Plotly.react("statusBarChart", [{
      x: labels,
      y: counts,
      type: 'bar',
      marker: { color: 'rgba(40, 167, 69, 0.7)' }
    }], {
      title: `–°—Ç–∞—Ç—É—Å—ã –∫–æ–º–ø–∞–Ω–∏–π –≤ —Ä–µ–≥–∏–æ–Ω–µ: ${regionName}`,
      xaxis: { title: "–°—Ç–∞—Ç—É—Å", automargin: true },
      yaxis: { title: "–ö–æ–º–ø–∞–Ω–∏–π", dtick: 1 }
    });
  }
</script>
{% endblock %}
