{% extends 'main/base.html' %}
{% block title %}–î–∞—à–±–æ—Ä–¥: –ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º{% endblock %}

{% block extra_css %}
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Custom styles -->
  <style>
    :root {
      --primary: #2C3E50;
      --accent: #E67E22;
      --success: #27AE60;
      --warning: #F1C40F;
      --danger:  #C0392B;
      --light-bg: #F8F9FA;
      --card-radius: 1rem;
      --transition: 0.3s ease;
      --font-base: 'Helvetica Neue', Arial, sans-serif;
    }
    body {
      font-family: var(--font-base);
      background-color: var(--light-bg);
    }
    h1, h4 {
      color: var(--primary);
    }
    #kazakhstan-map {
      width: 100%;
      height: 450px;
      border-radius: var(--card-radius);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .card {
      border: none;
      border-radius: var(--card-radius);
      transition: transform var(--transition), box-shadow var(--transition);
      overflow: hidden;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }
    .stat-card {
      padding: 1.5rem;
      text-align: center;
      color: #fff;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      margin-top: .5rem;
    }
    .region-card {
      background-color: #fff;
      cursor: pointer;
    }
    .region-card .card-header {
      background: linear-gradient(135deg, var(--accent), var(--primary));
      color: #fff;
      text-align: center;
      font-weight: 600;
    }
    .region-card ul {
      padding: 1rem;
      list-style: none;
      margin: 0;
    }
    .region-card li {
      display: flex;
      justify-content: space-between;
      padding: .5rem 0;
      border-bottom: 1px solid #eee;
    }
    .region-card li:last-child { border-bottom: none; }

    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 3rem;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <h1 class="mb-4">üìç –ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</h1>

  <!-- –ö–∞—Ä—Ç–∞ -->
  <div id="kazakhstan-map"></div>

  <!-- –ò—Ç–æ–≥–∏ -->
  <div class="row g-4 text-center">
    <div class="col-sm-6 col-lg-3">
      <div class="card stat-card" style="background: #34495E;">
        <div>–í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π</div>
        <div class="value" id="totalCompanies">{{ total_companies }}</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card stat-card" style="background: var(--warning);">
        <div>–°—É–º–º–∞—Ä–Ω—ã–π –¥–æ–ª–≥</div>
        <div class="value" id="totalDebt"></div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card stat-card" style="background: var(--success);">
        <div>–ü–æ–≥–∞—à–µ–Ω–æ</div>
        <div class="value" id="totalRepaid"></div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card stat-card" style="background: var(--danger);">
        <div>–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞</div>
        <div class="value" id="remainingDebt"></div>
      </div>
    </div>
  </div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º -->
  <h4 class="mt-5 mb-3">üìä –î–µ—Ç–∞–ª–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</h4>
  <div class="row g-4">
    {% for region in region_stats %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card region-card h-100" onclick="updateRegionCharts('{{ region.region }}')">
        <div class="card-header">{{ region.region }}</div>
        <ul>
          <li><span>üè¢ –ö–æ–º–ø–∞–Ω–∏–π:</span><span>{{ region.count }}</span></li>
          <li><span>üí∞ –î–æ–ª–≥:</span><span>{{ region.debt|floatformat:0 }} ‚Ç∏</span></li>
          <li><span>‚úÖ –ü–æ–≥–∞—à–µ–Ω–æ:</span><span>{{ region.paid|floatformat:0 }} ‚Ç∏</span></li>
          <li><span>üìà –û—Å—Ç–∞—Ç–æ–∫:</span><span>{{ region.debt|floatformat:0|add:'-'}}{{ region.paid|floatformat:0 }} ‚Ç∏</span></li>
        </ul>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
  <div class="charts-container">
    <div id="regionBarChart"></div>
    <div id="statusBarChart"></div>
    <div id="remainingDebtChart"></div>
  </div>
</div>

{{ region_stats|json_script:"region-data" }}
{{ status_stats|json_script:"status-data" }}
{% endblock %}

{% block extra_js %}
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    const regionData  = JSON.parse(document.getElementById('region-data').textContent);
    const statusData  = JSON.parse(document.getElementById('status-data').textContent);
    const initialDebt   = {{ total_debt|floatformat:0 }};
    const initialRepaid = {{ total_repaid|floatformat:0 }};

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    const fmt = x => x.toLocaleString('ru-RU') + ' ‚Ç∏';
    document.getElementById('totalDebt').innerText   = fmt(initialDebt);
    document.getElementById('totalRepaid').innerText = fmt(initialRepaid);
    document.getElementById('remainingDebt').innerText= fmt(initialDebt - initialRepaid);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    const map = L.map('kazakhstan-map').setView([48,66.9],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OSM' }).addTo(map);

    let geoLayer;
    let selectedLayer = null;
    fetch('/static/geo/gadm41_KAZ_1.json')
      .then(r=>r.json())
      .then(geojson=>{
        geoLayer = L.geoJSON(geojson,{  
          style: feature=>{
            const reg = regionData.find(r=>r.region===feature.properties.name);
            const ratio = reg ? reg.count/Math.max(...regionData.map(r=>r.count)) : 0;
            return { fillColor: `rgba(52,152,219,${0.3+0.7*ratio})`, weight:1, color:'#2980B9', fillOpacity:0.8 };
          },
          onEachFeature: (feature, layer)=>{
            layer.on('click', ()=>{
              // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
              if(selectedLayer) geoLayer.resetStyle(selectedLayer);
              // –í—ã–¥–µ–ª–∏—Ç—å –Ω–æ–≤—ã–π
              layer.setStyle({ weight:3, color:'#F39C12' });
              selectedLayer = layer;
              // –ó—É–º –Ω–∞ —Ä–µ–≥–∏–æ–Ω
              map.fitBounds(layer.getBounds());
              // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
              updateRegionCharts(feature.properties.name);
            });
            layer.bindTooltip(`<strong>${feature.properties.name}</strong><br>–ö–æ–º–ø–∞–Ω–∏–π: ${regionData.find(r=>r.region===feature.properties.name)?.count||0}`);
          }
        }).addTo(map);

        // –°–±—Ä–æ—Å –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É
        map.on('click', (e)=>{
          if(selectedLayer) geoLayer.resetStyle(selectedLayer);
          selectedLayer = null;
          // –°–±—Ä–æ—Å –Ω–∞ –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
          updateRegionCharts(null);
        });
      });

    // –ì—Ä–∞—Ñ–∏–∫–∏
    const regions = regionData.map(r=>r.region);
    const counts  = regionData.map(r=>r.count);
    const debts   = regionData.map(r=>r.debt - r.paid);
    Plotly.newPlot('regionBarChart',[{x:regions,y:counts,type:'bar',marker:{color:'#3498DB'}}],{title:'–ö–æ–º–ø–∞–Ω–∏–π –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º'});
    Plotly.newPlot('statusBarChart',[{x:statusData.map(s=>s.status__name),y:statusData.map(s=>s.count),type:'bar',marker:{color:'#2ECC71'}}],{title:'–ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º'});
    Plotly.newPlot('remainingDebtChart',[{x:regions,y:debts,type:'bar',marker:{color:'#E74C3C'}}],{title:'–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º'});

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
    function updateRegionCharts(name){
      if(!name){
        // –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        document.getElementById('totalCompanies').innerText = {{ total_companies }};
        document.getElementById('totalDebt').innerText      = fmt(initialDebt);
        document.getElementById('totalRepaid').innerText    = fmt(initialRepaid);
        document.getElementById('remainingDebt').innerText  = fmt(initialDebt - initialRepaid);
        Plotly.react('regionBarChart',[{x:regions,y:counts,type:'bar',marker:{color:'#3498DB'}}],{title:'–ö–æ–º–ø–∞–Ω–∏–π –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º'});
        Plotly.react('statusBarChart',[{x:statusData.map(s=>s.status__name),y:statusData.map(s=>s.count),type:'bar',marker:{color:'#2ECC71'}}],{title:'–ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º'});
        Plotly.react('remainingDebtChart',[{x:regions,y:debts,type:'bar',marker:{color:'#E74C3C'}}],{title:'–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º'});
        return;
      }
      const r = regionData.find(x=>x.region===name);
      document.getElementById('totalCompanies').innerText = r.count;
      document.getElementById('totalDebt').innerText      = fmt(r.debt);
      document.getElementById('totalRepaid').innerText    = fmt(r.paid);
      document.getElementById('remainingDebt').innerText  = fmt(r.debt - r.paid);

      Plotly.react('regionBarChart',[{x:[name],y:[r.count],type:'bar',marker:{color:'#3498DB'}}],{title:`–ö–æ–º–ø–∞–Ω–∏–π –≤ ${name}`});
      const byStatus = statusData.filter(s=>s.region===name);
      Plotly.react('statusBarChart',[{x:byStatus.map(s=>s.status__name),y:byStatus.map(s=>s.count),type:'bar',marker:{color:'#2ECC71'}}],{title:`–°—Ç–∞—Ç—É—Å—ã –≤ ${name}`});
      Plotly.react('remainingDebtChart',[{x:[name],y:[r.debt-r.paid],type:'bar',marker:{color:'#E74C3C'}}],{title:`–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞ –≤ ${name}`});
    }
  </script>
{% endblock %}
