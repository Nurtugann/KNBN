{% extends 'main/base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
  <style>
    :root {
      --primary: #4E73DF;
      --primary-dark: #224ABE;
      --success: #1CC88A;
      --info:    #36B9CC;
      --warning: #F6C23E;
      --danger:  #E74A3B;
      --light:   #F8F9FC;
      --dark:    #5A5C69;
      --gray:    #858796;
      --radius:  0.75rem;
      --transition: 0.3s ease;
    }
    body {
      background-color: var(--light);
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    .page-header h1 {
      color: var(--dark);
      font-size: 2rem;
      font-weight: 600;
    }
    .btn-add {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .btn-add:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    .filter-card {
      background: #fff;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      margin-bottom: 2rem;
    }
    .company-card {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      transition: transform var(--transition), box-shadow var(--transition);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .company-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    .company-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      font-size: 1.1rem;
    }
    .company-card .card-header a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: calc(100% - 80px);
    }
    .company-card .badge-status {
      font-size: 0.75rem;
      padding: 0.3rem 0.6rem;
      border-radius: 50px;
      text-transform: uppercase;
    }
    .company-card .card-body {
      padding: 1rem 1.5rem;
      flex-grow: 1;
    }
    .company-card .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .company-card .info-list li {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #eaeaea;
      font-size: 0.9rem;
      color: var(--dark);
    }
    .company-card .info-list li:last-child { border-bottom: none; }
    .company-card .info-list strong { color: var(--gray); }
    .company-card .card-footer {
      background: var(--light);
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--gray);
    }
    .company-card .card-footer .amount {
      font-weight: 600;
      color: var(--dark);
    }
    .company-card .card-footer .debt { color: var(--danger); }
    .company-card .card-footer .repaid { color: var(--success); }
    .empty-state {
      background: #fff;
      border-radius: var(--radius);
      text-align: center;
      padding: 3rem 1.5rem;
      grid-column: 1 / -1;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .empty-state i {
      font-size: 3rem;
      color: var(--gray);
      margin-bottom: 1rem;
    }
    .empty-state h4 { color: var(--dark); margin-bottom: 0.5rem; }
    .empty-state p  { color: var(--gray); margin-bottom: 1rem; }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4 py-lg-5">
  <div class="page-header d-flex flex-wrap justify-content-between align-items-center mb-4">
    <h1 class="mb-2 mb-md-0">{{ title }}</h1>
    <a href="{% url 'main:add_company' %}" class="btn-add">
      <i class="bi bi-plus-lg"></i> Добавить компанию
    </a>
  </div>

  <div class="filter-card">
    <form method="get" class="row gx-3 gy-2 align-items-end">
      <div class="col-sm-6 col-md-4">
        <label for="id_q" class="form-label">Поиск</label>
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-search text-gray"></i></span>
          <input type="text" id="id_q" name="q" class="form-control" value="{{ request.GET.q|default_if_none:'' }}" placeholder="Название или БИН">
        </div>
      </div>
      <div class="col-sm-6 col-md-4">
        <label for="id_status" class="form-label">Статус</label>
        <select id="id_status" name="status" class="form-select">
          <option value="">Все</option>
          {% for st in statuses %}
            <option value="{{ st.id }}" {% if request.GET.status == st.id|stringformat:"s" %}selected{% endif %}>{{ st.name }}</option>
          {% endfor %}
        </select>
      </div>
      {% if user.is_staff %}
      <div class="col-sm-6 col-md-4">
        <label for="id_region" class="form-label">Регион</label>
        <select id="id_region" name="region" class="form-select">
          <option value="">Все</option>
          {% for code,name in regions %}
            <option value="{{ code }}" {% if request.GET.region == code %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div class="col-sm-6 col-md-4">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-filter me-2"></i> Фильтровать
        </button>
      </div>
    </form>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
    {% for c in companies %}
    <div class="col">
      <div class="company-card h-100">
        <div class="card-header">
          <a href="{% url 'main:company_detail' c.pk %}">{{ c.name|truncatechars:30 }}</a>
          {% if c.status %}
            <span class="badge-status badge-status-{{ c.status.color|default:'primary' }}">{{ c.status.name }}</span>
          {% else %}
            <span class="badge-status badge-status-default">—</span>
          {% endif %}
        </div>
        <div class="card-body">
          <ul class="info-list">
            <li><strong>Регион:</strong><span>{{ c.get_region_display|default:'—' }}</span></li>
            <li><strong>Управляющий:</strong><span>{{ c.manager_name|default:'—' }}</span></li>
            <li><strong>БИН:</strong><span>{{ c.bin_number|default:'—' }}</span></li>
            <li><strong>Дней в статусе:</strong><span>{% if c.days_in_status is not None %}{{ c.days_in_status }} дн.{% else %}—{% endif %}</span></li>
          </ul>
        </div>
        <div class="card-footer">
          <div>
            <small>Создано</small><br>
            {{ c.created_at|date:"d.m.Y" }}
          </div>
          <div class="text-end">
            <div><small>Долг:</small> <span class="amount debt">{{ c.debt_amount|default_if_none:'0'|floatformat:0 }} ₸</span></div>
            <div><small>Погашено:</small> <span class="amount repaid">{{ c.repaid_amount|default_if_none:'0'|floatformat:0 }} ₸</span></div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <i class="bi bi-inbox"></i>
      <h4>Компании не найдены</h4>
      <p>Измените фильтры или добавьте новую компанию.</p>
      <a href="?" class="btn btn-outline-secondary me-2"><i class="bi bi-arrow-counterclockwise"></i> Сбросить</a>
      <a href="{% url 'main:add_company' %}" class="btn-add"><i class="bi bi-plus-lg"></i> Добавить компанию</a>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
