{% extends 'main/base.html' %}
{% block title %}–¢–∞–±–ª–∏—á–Ω—ã–π –æ–±–∑–æ—Ä: –ö–æ–º–ø–∞–Ω–∏–∏ –∏ –°—Ç–∞—Ç—É—Å—ã{% endblock %}

{% block extra_css %}
  <style>
    .sticky-col {
      position: -webkit-sticky;
      position: sticky;
      left: 0;
      background-color: #ffffff;
      z-index: 2;
      min-width: 200px;
    }
    .group-toggle-buttons {
      margin-bottom: 1rem;
    }
    .group-toggle-buttons button {
      margin-right: 0.5rem;
    }
    .table-scroll-wrapper {
      overflow-x: auto;
      position: relative;
      padding-top: 16px;
    }
    .table-scroll-wrapper .fake-scrollbar {
      height: 16px;
      overflow-x: auto;
      overflow-y: hidden;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #f8f9fa;
      z-index: 3;
    }
    .table-scroll-wrapper .fake-scrollbar .scroll-content {
      height: 1px;
    }
    .table-responsive {
      width: 100%;
      overflow-x: auto;
    }
    th.status-header {
      min-width: 100px;
      max-width: 160px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.8rem;
    }
    td.no-pad {
      padding: 0 !important;
    }
    td.no-pad a {
      display: block;
      padding: 0.25rem 0.5rem;
    }
    .hidden-group {
      display: none !important;
    }
  </style>
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const wrapper       = document.querySelector('.table-scroll-wrapper');
      const fakeScrollbar = document.querySelector('.table-scroll-wrapper .fake-scrollbar');
      const scrollContent = fakeScrollbar.querySelector('.scroll-content');
      const tableResp     = document.querySelector('.table-responsive');
      const mainTable     = document.getElementById('mainTable');

      if (!wrapper || !fakeScrollbar || !scrollContent || !tableResp || !mainTable) return;

      function syncScrollWidth() {
        const fullWidth = mainTable.scrollWidth;
        scrollContent.style.width = fullWidth + 'px';
      }
      syncScrollWidth();
      window.addEventListener('resize', syncScrollWidth);

      fakeScrollbar.addEventListener('scroll', function() {
        tableResp.scrollLeft = fakeScrollbar.scrollLeft;
      });
      tableResp.addEventListener('scroll', function() {
        fakeScrollbar.scrollLeft = tableResp.scrollLeft;
      });

      document.querySelectorAll('.toggle-group').forEach(btn => {
        btn.addEventListener('click', function() {
          const groupNum = this.dataset.group;
          const headers = document.querySelectorAll('th.group-' + groupNum);
          const cells = document.querySelectorAll('td.group-' + groupNum);
          const hidden = [...headers].every(h => h.classList.contains('hidden-group'));
          headers.forEach(h => h.classList.toggle('hidden-group', !hidden));
          cells.forEach(c => c.classList.toggle('hidden-group', !hidden));
        });
      });
    });
  </script>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h1>–¢–∞–±–ª–∏—á–Ω—ã–π –æ–±–∑–æ—Ä: –ö–æ–º–ø–∞–Ω–∏–∏ –∏ –°—Ç–∞—Ç—É—Å—ã</h1>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">{{ title }}</h1>
    <a href="{% url 'main:add_company' %}" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é</a>
  </div>

  <form method="get" class="row gx-2 gy-2 align-items-center mb-4">
    <div class="col-12 col-md-6">
      <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –ë–ò–ù...">
    </div>
    <div class="col-auto">
      <select name="region" class="form-select">
        <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
        {% for code,name in regions %}
          <option value="{{ code }}" {% if code == current_region %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="overdue" id="overdueCheck" value="1" {% if overdue_filter %}checked{% endif %}>
        <label class="form-check-label" for="overdueCheck">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</label>
      </div>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </form>

  <div class="group-toggle-buttons">
    {% for group_name, group_statuses in grouped_statuses %}
      <button type="button" class="btn btn-outline-secondary btn-sm toggle-group" data-group="{{ forloop.counter0 }}">
        üëÅÔ∏è {{ group_name }}
      </button>
    {% endfor %}
  </div>

  <div class="table-scroll-wrapper">
    <div class="fake-scrollbar"><div class="scroll-content"></div></div>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle mb-0" id="mainTable">
        <thead class="table-light">
          <tr>
            <th class="sticky-col" rowspan="2" scope="col">–ö–æ–º–ø–∞–Ω–∏—è</th>
            {% for group_name, group_statuses in grouped_statuses %}
              <th class="text-center group-{{ forloop.counter0 }}" colspan="{{ group_statuses|length }}">{{ group_name }}</th>
            {% endfor %}
          </tr>
          <tr>
            {% for group_name, group_statuses in grouped_statuses %}
              {% for status in group_statuses %}
                <th class="status-header group-{{ forloop.parentloop.counter0 }}" title="{{ status.name }}">{{ status.name }}</th>
              {% endfor %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for company in companies %}
            <tr>
              <td class="sticky-col" style="vertical-align: middle; background-color: #fff;">
                <a href="{% url 'main:company_detail' company.pk %}"><strong>{{ company.name }}</strong></a>
              </td>
              {% for group_name, group_statuses in grouped_statuses %}
                {% for status in group_statuses %}
                  {% if status.order < company.max_reached %}
                    <td class="text-center bg-success-light no-pad group-{{ forloop.parentloop.counter0 }}">
                      <a href="{% url 'main:attach_docs' company.pk status.pk %}">‚úì</a>
                    </td>
                  {% elif status.order == company.max_reached %}
                    {% if company.is_paused %}
                      <td class="text-center bg-secondary text-white no-pad group-{{ forloop.parentloop.counter0 }}">
                        <a href="{% url 'main:attach_docs' company.pk status.pk %}">‚è∏</a>
                      </td>
                    {% elif company.is_overdue %}
                      <td class="text-center bg-danger text-white no-pad group-{{ forloop.parentloop.counter0 }}">
                        <a href="{% url 'main:attach_docs' company.pk status.pk %}">!</a>
                      </td>
                    {% else %}
                      <td class="text-center bg-warning text-dark no-pad group-{{ forloop.parentloop.counter0 }}">
                        <a href="{% url 'main:attach_docs' company.pk status.pk %}">‚Üí</a>
                      </td>
                    {% endif %}
                  {% else %}
                    <td class="text-center no-pad group-{{ forloop.parentloop.counter0 }}">
                      <a href="{% url 'main:attach_docs' company.pk status.pk %}"></a>
                    </td>
                  {% endif %}
                {% endfor %}
              {% endfor %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="1000" class="text-center">–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
